---
title: "NodeRED 空调 TCP 控制教程"
date: 2024-10-28T11:58:47+08:00
draft: true
---

* 背景
近期笔者帮一位客户做了 NodeRED 流定制，用于对接私有的空调 TCP 协议。现将对接的过程和结果整理成文，仅供参考。

最终的成品 NodeRED 流如下图所示。
[[file:/image/nodered-ac-flow-overview.png]]

* 需求
客户期望笔者通过 NodeRED 实现家中空调接入 HomeAssistant 系统。

本次客户有一定的网络知识，客户已经对空调原厂 APP 进行抓包，并整理出了一份详细的 TCP 协议空调指令表。
并且客户自己通过 NodeRED 创建了一个简单的 [[https://www.home-assistant.io/integrations/climate.mqtt/][MQTT Climate]]，能执行部分指令控制空调。
但是控制逻辑为单向，及 HA 向空调发送指令，但不会解析空调回复给 HA 的指令。

基于上述情况，本次的需求清单如下：
1. 逆向空调指令表，找出指令规律
2. NodeRED 流解析空调回复指令，及时将空调最新状态同步到 HA
3. NodeRED 对接空调所有功能：模式、风速、温度、开关
4. NodeRED 接入所有空调：客厅、次卧、主卧、书房

* 空调协议
客户提供了一份完整的指令抓包表，包含发送指令和接收指令。
以下表格为截取的一小部分指令详情。我们需要推断出“模式、风速、温度、开关”的指令生成规律。
|------+----+----+----+----+----+----+----+----+------|
| 区域 |  1 |  2 |  3 |  4 |  5 |  6 |  7 | 8  | 备注 |
|------+----+----+----+----+----+----+----+----+------|
| 客厅 | 32 | 03 | 9D | 6D | 00 | 04 | FF | BB | 查询 |
| 次卧 | 32 | 06 | 9D | 46 | 00 | 08 | 43 | B6 | 低风 |
| 书房 | 32 | 06 | 9C | 8F | 00 | 02 | 12 | 73 | 制冷 |
| 主卧 | 32 | 06 | 9C | EC | 00 | 1B | 23 | A7 | 27度 |
|------+----+----+----+----+----+----+----+----+------|





查询
|------+----+----+------+------+----+----+----+----|
| 区域 |  1 |  2 | 3    | 4    |  5 |  6 | 7  |  8 |
|------+----+----+------+------+----+----+----+----|
| 客厅 | 32 | 03 | _9D_ | _6D_ | 00 | 04 | FF | BB |
| 次卧 | 32 | 03 | _9D_ | _12_ | 00 | 04 | CE | 63 |
| 主卧 | 32 | 03 | _9C_ | _B7_ | 00 | 04 | DF | BC |
| 书房 | 32 | 03 | _9C_ | _5C_ | 00 | 04 | AF | 88 |
|------+----+----+------+------+----+----+----+----|

接收
|------+----+----+------+----+------+----+------+----+------+----+------+----+----|
| 区域 |  1 |  2 |    3 |  4 |    5 |  6 |    7 |  8 | 9    | 10 | 11   | 12 | 13 |
|------+----+----+------+----+------+----+------+----+------+----+------+----+----|
|      |    |    | 长度 |    | 开关 |    | 模式 |    | 风速 |    | 温度 |    |    |
|------+----+----+------+----+------+----+------+----+------+----+------+----+----|
| 客厅 | 32 | 03 |   08 | 00 |   01 | 00 |   02 | 00 | _08_ | 00 | 1C   | 8C | 98 |
| 次卧 | 32 | 03 |   08 | 00 |   01 | 00 |   02 | 00 | _02_ | 00 | 1B   | ED | 58 |
|------+----+----+------+----+------+----+------+----+------+----+------+----+----|

风速
|------+----+----+----+----+----+------+----+----+--------|
| 区域 |  1 |  2 |  3 | 4  |  5 | 6    |  7 |  8 | 备注   |
|------+----+----+----+----+----+------+----+----+--------|
| 客厅 | 32 | 06 | 9D | A1 | 00 | _08_ | F3 | 81 | 低风   |
| 客厅 | 32 | 06 | 9D | A1 | 00 | _04_ | F3 | 84 | 中风   |
| 客厅 | 32 | 06 | 9D | A1 | 00 | _02_ | 73 | 86 | 高风   |
| 客厅 | 32 | 06 | 9D | A1 | 00 | _01_ | 33 | 87 | 自动风 |
|------+----+----+----+----+----+------+----+----+--------|

|------+----+----+------+------+----+----+----+----+------|
| 区域 |  1 |  2 | 3    | 4    |  5 |  6 | 7  | 8  | 备注 |
|------+----+----+------+------+----+----+----+----+------|
| 客厅 | 32 | 06 | _9D_ | _A1_ | 00 | 08 | F3 | 81 | 低风 |
| 次卧 | 32 | 06 | _9D_ | _46_ | 00 | 08 | 43 | B6 | 低风 |
| 主卧 | 32 | 06 | _9C_ | _EB_ | 00 | 08 | D3 | AB | 低风 |
| 书房 | 32 | 06 | _9C_ | _90_ | 00 | 08 | A3 | B2 | 低风 |
|------+----+----+------+------+----+----+----+----+------|

模式
|------+----+----+----+----+----+------+----+----+------|
| 区域 |  1 |  2 |  3 | 4  |  5 | 6    | 7  |  8 | 备注 |
|------+----+----+----+----+----+------+----+----+------|
| 客厅 | 32 | 06 | 9D | A0 | 00 | _10_ | A2 | 4B | 制热 |
| 客厅 | 32 | 06 | 9D | A0 | 00 | _08_ | A2 | 41 | 送风 |
| 客厅 | 32 | 06 | 9D | A0 | 00 | _04_ | A2 | 44 | 除湿 |
| 客厅 | 32 | 06 | 9D | A0 | 00 | _02_ | 22 | 46 | 制冷 |
|------+----+----+----+----+----+------+----+----+------|

|------+----+----+------+------+----+----+----+----+------|
| 区域 |  1 |  2 | 3    | 4    |  5 |  6 |  7 |  8 | 备注 |
|------+----+----+------+------+----+----+----+----+------|
| 客厅 | 32 | 06 | _9D_ | _A0_ | 00 | 02 | 22 | 46 | 制冷 |
| 次卧 | 32 | 06 | _9D_ | _45_ | 00 | 02 | 33 | B1 | 制冷 |
| 主卧 | 32 | 06 | _9C_ | _EA_ | 00 | 02 | 02 | 6C | 制冷 |
| 书房 | 32 | 06 | _9C_ | _8F_ | 00 | 02 | 12 | 73 | 制冷 |
|------+----+----+------+------+----+----+----+----+------|

开关
|------+----+----+----+----+----+------+----+----+------|
| 区域 |  1 |  2 |  3 | 4  |  5 | 6    |  7 | 8  | 备注 |
|------+----+----+----+----+----+------+----+----+------|
| 客厅 | 32 | 06 | 9D | 9F | 00 | _01_ | 52 | 4B | 开   |
| 客厅 | 32 | 06 | 9D | 9F | 00 | _00_ | 93 | 8B | 关   |
|------+----+----+----+----+----+------+----+----+------|

|------+----+----+------+------+----+----+----+----+------|
| 区域 |  1 |  2 | 3    | 4    |  5 |  6 |  7 |  8 | 备注 |
|------+----+----+------+------+----+----+----+----+------|
| 客厅 | 32 | 06 | _9D_ | _9F_ | 00 | 01 | 52 | 4B | 开   |
| 次卧 | 32 | 06 | _9D_ | _44_ | 00 | 01 | 22 | 70 | 开   |
| 主卧 | 32 | 06 | _9C_ | _E9_ | 00 | 01 | B2 | 6D | 开   |
| 书房 | 32 | 06 | _9C_ | _8E_ | 00 | 01 | 03 | B2 | 开   |
|------+----+----+------+------+----+----+----+----+------|

温度
|------+----+----+----+----+----+------+----+----+------|
| 区域 |  1 |  2 |  3 | 4  |  5 | 6    |  7 |  8 | 备注 |
|------+----+----+----+----+----+------+----+----+------|
| 客厅 | 32 | 06 | 9D | A2 | 00 | _1B_ | 42 | 4C | 27度 |
| 客厅 | 32 | 06 | 9D | A2 | 00 | _1C_ | 03 | 8E | 28度 |
|------+----+----+----+----+----+------+----+----+------|

|------+----+----+------+------+----+----+----+----+------|
| 区域 |  1 |  2 | 3    | 4    |  5 | 6  |  7 | 8  | 备注 |
|------+----+----+------+------+----+----+----+----+------|
| 客厅 | 32 | 06 | _9D_ | _A2_ | 00 | 1B | 42 | 4C | 27度 |
| 次卧 | 32 | 06 | _9D_ | _47_ | 00 | 1B | 53 | BB | 27度 |
| 主卧 | 32 | 06 | _9C_ | _EC_ | 00 | 1B | 23 | A7 | 27度 |
| 书房 | 32 | 06 | _9C_ | _91_ | 00 | 1B | B3 | BF | 27度 |
|------+----+----+------+------+----+----+----+----+------|


* NodeRED 流

#+begin_src js
[{"id":"f70bf744855de309","type":"tab","label":"空调新风","disabled":false,"info":"","env":[]},{"id":"7931bb89e59d6474","type":"group","z":"f70bf744855de309","name":"生成指令","style":{"label":true},"nodes":["b0a809b5d6f568f9","162504706ee01abc","499f9b71b77b1636","aee7d1da820f8a22","f7a8ae230fde8ef2","205335c3a4624f4a","73d1c23e717530ab","7b6f10e89f3def5f"],"x":834,"y":39,"w":302,"h":382},{"id":"565def7d5f0fc63c","type":"group","z":"f70bf744855de309","style":{"stroke":"#999999","stroke-opacity":"1","fill":"none","fill-opacity":"1","label":true,"label-position":"nw","color":"#a4a4a4"},"nodes":["ad899e1649829c0a","d777834d68f0fa04","51cd66b9fe746be2","92e3c7fea2abb87c"],"x":48,"y":33,"w":764,"h":714},{"id":"c2abd23090095c56","type":"group","z":"f70bf744855de309","name":"处理 TCP 空调数据","style":{"label":true},"nodes":["9060db5bced36305","1728faef5db3e51b","504f4e9f62cb8c06","26318e135fc4740a","7f7645f97c203af0","386bc3f22dc94168","6ed220f21860290f","c93c81d751abee1c","9a3baec62827e060","4f1fe41f9e1dfbd7","9a25853410ac1f44"],"x":834,"y":439,"w":532,"h":322},{"id":"e91485caa14f8135","type":"group","z":"f70bf744855de309","name":"TCP 服务器","style":{"label":true},"nodes":["d6680e862f160315","e7812bf0e1cb0c91","be8eb37022bef7cb","6384010944df21a9","2b089d04f37508c6","68a5a7a7fd165e3f"],"x":1174,"y":39,"w":412,"h":262},{"id":"1cc612bb590ca0b2","type":"group","z":"f70bf744855de309","name":"处理 TCP 新风数据","style":{"label":true},"nodes":["6367de177fb9dd18","deedb092575cb7fc","eca2bfb6f0514243","2d762b9fec87a022","8aca0ae955343086","d8c6e58f518b3332","5bebd8c7ad630176","11ac295d8119c5fd","4fc7947b38f45cbf"],"x":834,"y":779,"w":532,"h":262},{"id":"18cbecd2d2bc9db6","type":"group","z":"f70bf744855de309","name":"新风","style":{"label":true},"nodes":["77884df4e2ba295c","c385db848e2f7baf","1bcc5df7fcbc91e0","c3d7c7f08d2f44a1","25f6df45e5d0d842"],"x":54,"y":779,"w":452,"h":202},{"id":"609d620537312d9b","type":"group","z":"f70bf744855de309","name":"生成指令","style":{"label":true},"nodes":["5e3679fccf5238c0","94eb991704d673e3","16720f56ed9e68e1","434516469018af7a","1f0874717c018c27","bc5d1bbf9b164e5b","288b15122ef03e69","a7803743c8e0283c"],"x":54,"y":999,"w":302,"h":382},{"id":"ad899e1649829c0a","type":"group","z":"f70bf744855de309","g":"565def7d5f0fc63c","name":"主卧","style":{"label":true},"nodes":["7c163440cd5e5728","4f8e941555741c86","d88afbe19e89d005","c94f8a70e44a1b0e","6e2319909b68b574","d9a73706df5a31dc"],"x":74,"y":399,"w":352,"h":322},{"id":"d777834d68f0fa04","type":"group","z":"f70bf744855de309","g":"565def7d5f0fc63c","name":"次卧","style":{"label":true},"nodes":["0242bfd9d489ecb6","f4f737f08978196d","d9e66e73535f1880","425e232ce3f498b0","fb34ad6ec9e171b5","c21224eacc8ffcb5"],"x":434,"y":59,"w":352,"h":322},{"id":"51cd66b9fe746be2","type":"group","z":"f70bf744855de309","g":"565def7d5f0fc63c","name":"客厅","style":{"label":true},"nodes":["fafac45cfdeb367d","3f0801fc2b5ceac6","ba669a2336a87ddc","3910ffcfc4edd0fb","2a80eafcbe6d0276","52b73e41bfbdd5da"],"x":434,"y":399,"w":352,"h":322},{"id":"92e3c7fea2abb87c","type":"group","z":"f70bf744855de309","g":"565def7d5f0fc63c","name":"书房","style":{"label":true},"nodes":["d5c213255930f11d","680902d4afc38e02","f85830fbe489635c","325159b416f0bf7f","1509b68e540c3600","2cf0fc0a9b229a47"],"x":94,"y":59,"w":332,"h":322},{"id":"3e3a0797b89a9356","type":"comment","z":"f70bf744855de309","name":"协议说明","info":"空调地址：\n| 客厅 | 0x9D 0x6C |                                                                                                                                                                \n| 次卧 | 0x9D 0x11 |                                                                                                                                                                \n| 主卧 | 0x9C 0xB6 |                                                                                                                                                                \n| 书房 | 0x9C 0x5B | \n\n指令：\n查询性能 0x01\n控制风速 0x35                                                                                                                                                                       \n控制模式 0x34                                                                                                                                                                       \n控制开关 0x33                                                                                                                                                                       \n控制温度 0x36","x":120,"y":20,"wires":[]},{"id":"f85830fbe489635c","type":"mqtt in","z":"f70bf744855de309","g":"92e3c7fea2abb87c","name":"","topic":"study/ac/power_set","qos":"2","datatype":"auto-detect","broker":"3c5783772d0bda43","nl":false,"rap":true,"rh":0,"inputs":0,"x":210,"y":100,"wires":[["680902d4afc38e02"]]},{"id":"d5c213255930f11d","type":"mqtt in","z":"f70bf744855de309","g":"92e3c7fea2abb87c","name":"","topic":"study/ac/mode_set","qos":"2","datatype":"auto-detect","broker":"3c5783772d0bda43","nl":false,"rap":true,"rh":0,"inputs":0,"x":210,"y":160,"wires":[["680902d4afc38e02"]]},{"id":"325159b416f0bf7f","type":"mqtt in","z":"f70bf744855de309","g":"92e3c7fea2abb87c","name":"","topic":"study/ac/target_temperature_set","qos":"2","datatype":"auto-detect","broker":"3c5783772d0bda43","nl":false,"rap":true,"rh":0,"inputs":0,"x":250,"y":220,"wires":[["680902d4afc38e02"]]},{"id":"b0a809b5d6f568f9","type":"function","z":"f70bf744855de309","g":"7931bb89e59d6474","name":"设置设备地址","func":"let mqtt_topic_ac_name_to_addr = {\n    \"study\": [0x9C, 0x5B],\n    \"master\": [0x9C, 0xB6],\n    \"second\": [0x9D, 0x11],\n    \"living\": [0x9D, 0x6C],\n    \"xinfeng\": [0x9D, 0xC7],\n};\n\nmsg.ac_info = msg.ac_info || {};\n\nlet mqtt_topic_ac_name = msg.topic.split('/')[0];\nmsg.ac_info.name = mqtt_topic_ac_name;\nmsg.ac_info.addr = mqtt_topic_ac_name_to_addr[mqtt_topic_ac_name];\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1000,"y":140,"wires":[["162504706ee01abc"]]},{"id":"162504706ee01abc","type":"function","z":"f70bf744855de309","g":"7931bb89e59d6474","name":"设置指令","func":"let mqtt_topic_cmd_name_to_cmd = {\n    \"target_temperature_set\": 0x36,\n    \"mode_set\": 0x34,\n    \"power_set\": 0x33,\n    \"fan_mode_set\": 0x35,\n    \"state_query\": 0x01,\n};\n\nmsg.ac_info = msg.ac_info || {};\n\nlet splits = msg.topic.split('/');\nlet mqtt_topic_cmd_name = splits[splits.length - 1];\n\nmsg.ac_info.cmds = []; // 一个 mq 消息，可能需要多个空调指令才能完成任务\n\nif (mqtt_topic_cmd_name == \"target_temperature_set\") {\n    msg.ac_info.cmds.push({\n        cmd: mqtt_topic_cmd_name_to_cmd[mqtt_topic_cmd_name],\n        val: msg.payload\n    });\n}\n\nlet mqtt_payload_mode_name_to_cmd_val = {\n    \"fan_only\": 0x08,\n    \"dry\": 0x04,\n    \"cool\": 0x02,\n    \"heat\": 0x10,\n}\n\nif (mqtt_topic_cmd_name == \"mode_set\") {\n    if (msg.payload != \"off\") {\n        msg.ac_info.cmds.push({\n            cmd: mqtt_topic_cmd_name_to_cmd[mqtt_topic_cmd_name],\n            val: mqtt_payload_mode_name_to_cmd_val[msg.payload],\n        });\n\n        // 追加一条强制开机\n        msg.ac_info.cmds.push({\n            cmd: mqtt_topic_cmd_name_to_cmd[\"power_set\"],\n            val: 0x01,\n        });\n    } else {\n        msg.ac_info.cmds.push({\n            cmd: mqtt_topic_cmd_name_to_cmd[\"power_set\"],\n            val: 0x00,\n        });\n    }\n}\n\nif (mqtt_topic_cmd_name == \"power_set\") {\n    msg.ac_info.cmds.push({\n        cmd: mqtt_topic_cmd_name_to_cmd[mqtt_topic_cmd_name],\n        val: msg.payload == \"ON\" ? 0x01 : 0x00\n    });\n}\n\nlet mqtt_payload_fan_mode_name_to_cmd_val = {\n    \"high\": 0x02,\n    \"medium\": 0x04,\n    \"low\": 0x08,\n    \"auto\": 0x01,\n}\n\nif (mqtt_topic_cmd_name == \"fan_mode_set\") {\n    msg.ac_info.cmds.push({\n        cmd: mqtt_topic_cmd_name_to_cmd[mqtt_topic_cmd_name],\n        val: mqtt_payload_fan_mode_name_to_cmd_val[msg.payload]\n    });\n}\n\nif (mqtt_topic_cmd_name == \"state_query\") {\n    msg.ac_info.cmds.push({\n        cmd: mqtt_topic_cmd_name_to_cmd[mqtt_topic_cmd_name],\n        val: msg.payload\n    });\n}\n\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":980,"y":200,"wires":[["499f9b71b77b1636"]]},{"id":"499f9b71b77b1636","type":"function","z":"f70bf744855de309","g":"7931bb89e59d6474","name":"生成控制指令","func":"msg.ac_info.raw_cmds = [];\nmsg.ac_info.cmds.forEach(e => {\n    msg.ac_info.raw_cmds.push(Buffer.from([\n        0x32, e.cmd == 0x01 ? 0x03 : 0x06,\n        msg.ac_info.addr[0], msg.ac_info.addr[1] + e.cmd,\n        0x00,\n        e.val\n    ]));\n});\n\nmsg.payload = msg.ac_info.raw_cmds;\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1000,"y":260,"wires":[["aee7d1da820f8a22"]]},{"id":"aee7d1da820f8a22","type":"split","z":"f70bf744855de309","g":"7931bb89e59d6474","name":"拆分多条指令","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","property":"payload","x":1000,"y":320,"wires":[["f7a8ae230fde8ef2"]]},{"id":"f7a8ae230fde8ef2","type":"function","z":"f70bf744855de309","g":"7931bb89e59d6474","name":"crc16","func":"// CRC-16 Modbus计算函数\nfunction crc16(buffer) {\n    let crc = 0xFFFF;\n    for (let i = 0; i < buffer.length; i++) {\n        crc ^= buffer[i]; // XOR byte into least sig. byte of crc\n        for (let j = 0; j < 8; j++) { // Loop over each bit\n            if ((crc & 0x0001) !== 0) {\n                crc >>= 1; // Shift right and XOR 0xA001 if the LSB is 1\n                crc ^= 0xA001;\n            } else {\n                crc >>= 1; // Just shift right\n            }\n        }\n    }\n    // CRC-16输出为2字节，低字节在前，高字节在后\n    return Buffer.from([crc & 0xFF, (crc >> 8) & 0xFF]);\n}\n\n// 获取输入的msg.payload（假设为Buffer）\nlet data = msg.payload;\n\n// 计算CRC\nlet crc = crc16(data);\n\n// 将CRC附加到原始数据\nmsg.payload = Buffer.concat([data, crc]);\n\n// 返回msg\nreturn msg;\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":970,"y":380,"wires":[["73d1c23e717530ab"]]},{"id":"d6680e862f160315","type":"debug","z":"f70bf744855de309","g":"e91485caa14f8135","name":"空调指令","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1440,"y":160,"wires":[]},{"id":"1509b68e540c3600","type":"mqtt in","z":"f70bf744855de309","g":"92e3c7fea2abb87c","name":"","topic":"study/ac/fan_mode_set","qos":"2","datatype":"auto-detect","broker":"3c5783772d0bda43","nl":false,"rap":true,"rh":0,"inputs":0,"x":220,"y":280,"wires":[["680902d4afc38e02"]]},{"id":"680902d4afc38e02","type":"link out","z":"f70bf744855de309","g":"92e3c7fea2abb87c","name":"link out 1","mode":"link","links":["205335c3a4624f4a"],"x":385,"y":160,"wires":[]},{"id":"205335c3a4624f4a","type":"link in","z":"f70bf744855de309","g":"7931bb89e59d6474","name":"link in 1","links":["680902d4afc38e02","6e2319909b68b574","fb34ad6ec9e171b5","2a80eafcbe6d0276"],"x":875,"y":80,"wires":[["7b6f10e89f3def5f"]]},{"id":"7c163440cd5e5728","type":"mqtt in","z":"f70bf744855de309","g":"ad899e1649829c0a","name":"","topic":"master/ac/fan_mode_set","qos":"2","datatype":"auto-detect","broker":"3c5783772d0bda43","nl":false,"rap":true,"rh":0,"inputs":0,"x":230,"y":620,"wires":[["6e2319909b68b574"]]},{"id":"4f8e941555741c86","type":"mqtt in","z":"f70bf744855de309","g":"ad899e1649829c0a","name":"","topic":"master/ac/power_set","qos":"2","datatype":"auto-detect","broker":"3c5783772d0bda43","nl":false,"rap":true,"rh":0,"inputs":0,"x":220,"y":440,"wires":[["6e2319909b68b574"]]},{"id":"d88afbe19e89d005","type":"mqtt in","z":"f70bf744855de309","g":"ad899e1649829c0a","name":"","topic":"master/ac/mode_set","qos":"2","datatype":"auto-detect","broker":"3c5783772d0bda43","nl":false,"rap":true,"rh":0,"inputs":0,"x":210,"y":500,"wires":[["6e2319909b68b574"]]},{"id":"c94f8a70e44a1b0e","type":"mqtt in","z":"f70bf744855de309","g":"ad899e1649829c0a","name":"","topic":"master/ac/target_temperature_set","qos":"2","datatype":"auto-detect","broker":"3c5783772d0bda43","nl":false,"rap":true,"rh":0,"inputs":0,"x":260,"y":560,"wires":[["6e2319909b68b574"]]},{"id":"6e2319909b68b574","type":"link out","z":"f70bf744855de309","g":"ad899e1649829c0a","name":"link out 2","mode":"link","links":["205335c3a4624f4a"],"x":385,"y":500,"wires":[]},{"id":"0242bfd9d489ecb6","type":"mqtt in","z":"f70bf744855de309","g":"d777834d68f0fa04","name":"","topic":"second/ac/fan_mode_set","qos":"2","datatype":"auto-detect","broker":"3c5783772d0bda43","nl":false,"rap":true,"rh":0,"inputs":0,"x":590,"y":280,"wires":[["fb34ad6ec9e171b5"]]},{"id":"f4f737f08978196d","type":"mqtt in","z":"f70bf744855de309","g":"d777834d68f0fa04","name":"","topic":"second/ac/power_set","qos":"2","datatype":"auto-detect","broker":"3c5783772d0bda43","nl":false,"rap":true,"rh":0,"inputs":0,"x":580,"y":100,"wires":[["fb34ad6ec9e171b5"]]},{"id":"d9e66e73535f1880","type":"mqtt in","z":"f70bf744855de309","g":"d777834d68f0fa04","name":"","topic":"second/ac/mode_set","qos":"2","datatype":"auto-detect","broker":"3c5783772d0bda43","nl":false,"rap":true,"rh":0,"inputs":0,"x":580,"y":160,"wires":[["fb34ad6ec9e171b5"]]},{"id":"425e232ce3f498b0","type":"mqtt in","z":"f70bf744855de309","g":"d777834d68f0fa04","name":"","topic":"second/ac/target_temperature_set","qos":"2","datatype":"auto-detect","broker":"3c5783772d0bda43","nl":false,"rap":true,"rh":0,"inputs":0,"x":620,"y":220,"wires":[["fb34ad6ec9e171b5"]]},{"id":"fb34ad6ec9e171b5","type":"link out","z":"f70bf744855de309","g":"d777834d68f0fa04","name":"link out 3","mode":"link","links":["205335c3a4624f4a"],"x":745,"y":160,"wires":[]},{"id":"fafac45cfdeb367d","type":"mqtt in","z":"f70bf744855de309","g":"51cd66b9fe746be2","name":"","topic":"living/ac/fan_mode_set","qos":"2","datatype":"auto-detect","broker":"3c5783772d0bda43","nl":false,"rap":true,"rh":0,"inputs":0,"x":580,"y":620,"wires":[["2a80eafcbe6d0276"]]},{"id":"3f0801fc2b5ceac6","type":"mqtt in","z":"f70bf744855de309","g":"51cd66b9fe746be2","name":"","topic":"living/ac/power_set","qos":"2","datatype":"auto-detect","broker":"3c5783772d0bda43","nl":false,"rap":true,"rh":0,"inputs":0,"x":570,"y":440,"wires":[["2a80eafcbe6d0276"]]},{"id":"ba669a2336a87ddc","type":"mqtt in","z":"f70bf744855de309","g":"51cd66b9fe746be2","name":"","topic":"living/ac/mode_set","qos":"2","datatype":"auto-detect","broker":"3c5783772d0bda43","nl":false,"rap":true,"rh":0,"inputs":0,"x":570,"y":500,"wires":[["2a80eafcbe6d0276"]]},{"id":"3910ffcfc4edd0fb","type":"mqtt in","z":"f70bf744855de309","g":"51cd66b9fe746be2","name":"","topic":"living/ac/target_temperature_set","qos":"2","datatype":"auto-detect","broker":"3c5783772d0bda43","nl":false,"rap":true,"rh":0,"inputs":0,"x":610,"y":560,"wires":[["2a80eafcbe6d0276"]]},{"id":"2a80eafcbe6d0276","type":"link out","z":"f70bf744855de309","g":"51cd66b9fe746be2","name":"link out 4","mode":"link","links":["205335c3a4624f4a"],"x":745,"y":500,"wires":[]},{"id":"2cf0fc0a9b229a47","type":"inject","z":"f70bf744855de309","g":"92e3c7fea2abb87c","name":"study/ac/state_query","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"10","crontab":"","once":false,"onceDelay":"1","topic":"study/ac/state_query","payload":"0x04","payloadType":"num","x":240,"y":340,"wires":[["680902d4afc38e02"]]},{"id":"c21224eacc8ffcb5","type":"inject","z":"f70bf744855de309","g":"d777834d68f0fa04","name":"second/ac/state_query","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"10","crontab":"","once":true,"onceDelay":"1","topic":"second/ac/state_query","payload":"0x04","payloadType":"num","x":590,"y":340,"wires":[["fb34ad6ec9e171b5"]]},{"id":"d9a73706df5a31dc","type":"inject","z":"f70bf744855de309","g":"ad899e1649829c0a","name":"master/ac/state_query","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"10","crontab":"","once":true,"onceDelay":"2","topic":"master/ac/state_query","payload":"0x04","payloadType":"num","x":230,"y":680,"wires":[["6e2319909b68b574"]]},{"id":"52b73e41bfbdd5da","type":"inject","z":"f70bf744855de309","g":"51cd66b9fe746be2","name":"living/ac/state_query","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"10","crontab":"","once":true,"onceDelay":"3","topic":"living/ac/state_query","payload":"0x04","payloadType":"num","x":580,"y":680,"wires":[["2a80eafcbe6d0276"]]},{"id":"e7812bf0e1cb0c91","type":"tcp request","z":"f70bf744855de309","g":"e91485caa14f8135","name":"","server":"192.168.188.200","port":"8899","out":"sit","ret":"buffer","splitc":" ","newline":"","trim":false,"tls":"","x":1320,"y":260,"wires":[["be8eb37022bef7cb","68a5a7a7fd165e3f"]]},{"id":"9060db5bced36305","type":"debug","z":"f70bf744855de309","g":"c2abd23090095c56","name":"mqtt待发送消息","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1240,"y":540,"wires":[]},{"id":"1728faef5db3e51b","type":"function","z":"f70bf744855de309","g":"c2abd23090095c56","name":"解析数值","func":"let on_off = msg.payload[4]; // 0: off, 1: on\nlet mode = msg.payload[6]; // mode\nlet fan_mode = msg.payload[8];\nlet temperature = msg.payload[10];\n\nmsg.payload = {\n    \"on_off\": on_off,\n    \"mode\": mode,\n    \"fan_mode\": fan_mode,\n    \"temperature\": temperature\n}\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":920,"y":540,"wires":[["504f4e9f62cb8c06","26318e135fc4740a","7f7645f97c203af0","386bc3f22dc94168"]]},{"id":"504f4e9f62cb8c06","type":"function","z":"f70bf744855de309","g":"c2abd23090095c56","name":"mode_state_topic","func":"msg.topic = msg.ac_info.name + \"/ac/mode_get\";\n\nif (msg.payload.on_off == 0) {\n    msg.payload = \"off\";\n} else if (msg.payload.on_off == 1) {\n    if (msg.payload.mode == 16) {\n        msg.payload = \"heat\";\n    } else if (msg.payload.mode == 8) {\n        msg.payload = \"fan_only\";\n    } else if (msg.payload.mode == 4) {\n        msg.payload = \"dry\";\n    } else if (msg.payload.mode == 2) {\n        msg.payload = \"cool\";\n    } else {\n        return null;\n    }\n} else {\n    return null;\n}\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":950,"y":600,"wires":[["c93c81d751abee1c"]]},{"id":"26318e135fc4740a","type":"function","z":"f70bf744855de309","g":"c2abd23090095c56","name":"fan_mode_state_topic","func":"msg.topic = msg.ac_info.name + \"/ac/fan_mode_get\";\n\nif (msg.payload.fan_mode == 1) {\n    msg.payload = \"auto\";\n} else if (msg.payload.fan_mode == 2) {\n    msg.payload = \"high\";\n} else if (msg.payload.fan_mode == 4) {\n    msg.payload = \"medium\";\n} else if (msg.payload.fan_mode == 8) {\n    msg.payload = \"low\";\n} else {\n    msg.payload = \"auto\";\n}\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":960,"y":640,"wires":[["c93c81d751abee1c"]]},{"id":"7f7645f97c203af0","type":"function","z":"f70bf744855de309","g":"c2abd23090095c56","name":"temperature_state_topic","func":"msg.topic = msg.ac_info.name + \"/ac/target_temperature_get\";\nmsg.payload = msg.payload.temperature;\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":970,"y":680,"wires":[["c93c81d751abee1c"]]},{"id":"386bc3f22dc94168","type":"function","z":"f70bf744855de309","g":"c2abd23090095c56","name":"current_temperature_topic","func":"msg.topic = msg.ac_info.name + \"/ac/current_temperature_get\";\nmsg.payload = msg.payload.temperature;\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":980,"y":720,"wires":[["c93c81d751abee1c"]]},{"id":"6ed220f21860290f","type":"mqtt out","z":"f70bf744855de309","g":"c2abd23090095c56","name":"","topic":"","qos":"2","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"3c5783772d0bda43","x":1210,"y":680,"wires":[]},{"id":"c93c81d751abee1c","type":"rbe","z":"f70bf744855de309","g":"c2abd23090095c56","name":"数据去重","func":"rbe","gap":"","start":"","inout":"out","septopics":true,"property":"payload","topi":"topic","x":1220,"y":600,"wires":[["9060db5bced36305","6ed220f21860290f"]]},{"id":"be8eb37022bef7cb","type":"debug","z":"f70bf744855de309","g":"e91485caa14f8135","name":"TCP 原始数据","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1460,"y":200,"wires":[]},{"id":"6384010944df21a9","type":"delay","z":"f70bf744855de309","g":"e91485caa14f8135","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":1270,"y":160,"wires":[["e7812bf0e1cb0c91","d6680e862f160315"]]},{"id":"2b089d04f37508c6","type":"link in","z":"f70bf744855de309","g":"e91485caa14f8135","name":"link in 2","links":["73d1c23e717530ab","288b15122ef03e69"],"x":1215,"y":80,"wires":[["6384010944df21a9"]]},{"id":"73d1c23e717530ab","type":"link out","z":"f70bf744855de309","g":"7931bb89e59d6474","name":"link out 5","mode":"link","links":["2b089d04f37508c6"],"x":1095,"y":380,"wires":[]},{"id":"68a5a7a7fd165e3f","type":"link out","z":"f70bf744855de309","g":"e91485caa14f8135","name":"link out 6","mode":"link","links":["9a3baec62827e060","5bebd8c7ad630176"],"x":1515,"y":260,"wires":[]},{"id":"9a3baec62827e060","type":"link in","z":"f70bf744855de309","g":"c2abd23090095c56","name":"link in 3","links":["68a5a7a7fd165e3f"],"x":875,"y":480,"wires":[["4f1fe41f9e1dfbd7"]]},{"id":"77884df4e2ba295c","type":"mqtt in","z":"f70bf744855de309","g":"18cbecd2d2bc9db6","name":"","topic":"xinfeng/xf/power_set","qos":"2","datatype":"auto-detect","broker":"3c5783772d0bda43","nl":false,"rap":true,"rh":0,"inputs":0,"x":200,"y":820,"wires":[["1bcc5df7fcbc91e0"]]},{"id":"c385db848e2f7baf","type":"mqtt in","z":"f70bf744855de309","g":"18cbecd2d2bc9db6","name":"","topic":"xinfeng/xf/fan_mode_set","qos":"2","datatype":"auto-detect","broker":"3c5783772d0bda43","nl":false,"rap":true,"rh":0,"inputs":0,"x":210,"y":880,"wires":[["1bcc5df7fcbc91e0","25f6df45e5d0d842"]]},{"id":"1bcc5df7fcbc91e0","type":"link out","z":"f70bf744855de309","g":"18cbecd2d2bc9db6","name":"link out 7","mode":"link","links":["bc5d1bbf9b164e5b"],"x":425,"y":880,"wires":[]},{"id":"c3d7c7f08d2f44a1","type":"inject","z":"f70bf744855de309","g":"18cbecd2d2bc9db6","name":"xinfeng/xf/state_query","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"10","crontab":"","once":true,"onceDelay":"5","topic":"xinfeng/xf/state_query","payload":"0x04","payloadType":"num","x":210,"y":940,"wires":[["1bcc5df7fcbc91e0"]]},{"id":"6367de177fb9dd18","type":"debug","z":"f70bf744855de309","g":"1cc612bb590ca0b2","name":"mqtt待发送消息","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1240,"y":880,"wires":[]},{"id":"deedb092575cb7fc","type":"switch","z":"f70bf744855de309","g":"1cc612bb590ca0b2","name":"数据包长度13","property":"payload.length","propertyType":"msg","rules":[{"t":"eq","v":"13","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":1000,"y":820,"wires":[["11ac295d8119c5fd"]]},{"id":"eca2bfb6f0514243","type":"function","z":"f70bf744855de309","g":"1cc612bb590ca0b2","name":"解析数值","func":"let on_off = msg.payload[4]; // 0: off, 1: on\nlet speed = msg.payload[8];\n\nmsg.payload = {\n    \"on_off\": on_off,\n    \"speed\": speed,\n}\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":920,"y":880,"wires":[["2d762b9fec87a022","4fc7947b38f45cbf"]]},{"id":"2d762b9fec87a022","type":"function","z":"f70bf744855de309","g":"1cc612bb590ca0b2","name":"state_topic","func":"msg.topic = msg.ac_info.name + \"/xf/state_get\";\n\nif (msg.payload.on_off == 0) {\n    msg.payload = \"OFF\";\n} else if (msg.payload.on_off == 1) {\n    msg.payload = \"ON\";\n} else {\n    return null;\n}\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":930,"y":940,"wires":[["d8c6e58f518b3332"]]},{"id":"8aca0ae955343086","type":"mqtt out","z":"f70bf744855de309","g":"1cc612bb590ca0b2","name":"","topic":"","qos":"2","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"3c5783772d0bda43","x":1210,"y":1000,"wires":[]},{"id":"d8c6e58f518b3332","type":"rbe","z":"f70bf744855de309","g":"1cc612bb590ca0b2","name":"数据去重","func":"rbe","gap":"","start":"","inout":"out","septopics":true,"property":"payload","topi":"topic","x":1220,"y":940,"wires":[["6367de177fb9dd18","8aca0ae955343086"]]},{"id":"5bebd8c7ad630176","type":"link in","z":"f70bf744855de309","g":"1cc612bb590ca0b2","name":"link in 4","links":["68a5a7a7fd165e3f"],"x":875,"y":820,"wires":[["deedb092575cb7fc"]]},{"id":"7b6f10e89f3def5f","type":"function","z":"f70bf744855de309","g":"7931bb89e59d6474","name":"设置设备类型","func":"msg.ac_info = msg.ac_info || {};\n\nlet mqtt_topic_ac_type = msg.topic.split('/')[1];\nmsg.ac_info.type = mqtt_topic_ac_type;\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1000,"y":80,"wires":[["b0a809b5d6f568f9"]]},{"id":"4f1fe41f9e1dfbd7","type":"switch","z":"f70bf744855de309","g":"c2abd23090095c56","name":"数据包长度13","property":"payload.length","propertyType":"msg","rules":[{"t":"eq","v":"13","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":1000,"y":480,"wires":[["9a25853410ac1f44"]]},{"id":"9a25853410ac1f44","type":"switch","z":"f70bf744855de309","g":"c2abd23090095c56","name":"类型为 ac","property":"ac_info.type","propertyType":"msg","rules":[{"t":"eq","v":"ac","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":1160,"y":480,"wires":[["1728faef5db3e51b"]]},{"id":"11ac295d8119c5fd","type":"switch","z":"f70bf744855de309","g":"1cc612bb590ca0b2","name":"类型为 ac","property":"ac_info.type","propertyType":"msg","rules":[{"t":"eq","v":"xf","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":1160,"y":820,"wires":[["eca2bfb6f0514243"]]},{"id":"4fc7947b38f45cbf","type":"function","z":"f70bf744855de309","g":"1cc612bb590ca0b2","name":"percentage_state_topic","func":"msg.topic = msg.ac_info.name + \"/xf/percentage_state_get\";\n\nif (msg.payload.speed == 0x02) { // 高风速\n    msg.payload = 2;\n} else if (msg.payload.speed == 0x04) { // 中风速\n    msg.payload = 1;\n} else {\n    return null;\n}\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":970,"y":1000,"wires":[["d8c6e58f518b3332"]]},{"id":"5e3679fccf5238c0","type":"function","z":"f70bf744855de309","g":"609d620537312d9b","name":"设置设备地址","func":"let mqtt_topic_ac_name_to_addr = {\n    \"study\": [0x9C, 0x5B],\n    \"master\": [0x9C, 0xB6],\n    \"second\": [0x9D, 0x11],\n    \"living\": [0x9D, 0x6C],\n    \"xinfeng\": [0x9D, 0xC7],\n};\n\nmsg.ac_info = msg.ac_info || {};\n\nlet mqtt_topic_ac_name = msg.topic.split('/')[0];\nmsg.ac_info.name = mqtt_topic_ac_name;\nmsg.ac_info.addr = mqtt_topic_ac_name_to_addr[mqtt_topic_ac_name];\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":220,"y":1100,"wires":[["94eb991704d673e3"]]},{"id":"94eb991704d673e3","type":"function","z":"f70bf744855de309","g":"609d620537312d9b","name":"设置指令","func":"let mqtt_topic_cmd_name_to_cmd = {\n    \"power_set\": 0x33,\n    \"fan_mode_set\": 0x35,\n    \"state_query\": 0x01,\n};\n\nmsg.ac_info = msg.ac_info || {};\n\nlet splits = msg.topic.split('/');\nlet mqtt_topic_cmd_name = splits[splits.length - 1];\n\nmsg.ac_info.cmds = []; // 一个 mq 消息，可能需要多个空调指令才能完成任务\n\nif (mqtt_topic_cmd_name == \"power_set\") {\n    msg.ac_info.cmds.push({\n        cmd: mqtt_topic_cmd_name_to_cmd[mqtt_topic_cmd_name],\n        val: msg.payload == \"ON\" ? 0x01 : 0x00\n    });\n}\n\nlet mqtt_payload_fan_mode_name_to_cmd_val = {\n    \"2\": 0x02,\n    \"1\": 0x04,\n}\n\nif (mqtt_topic_cmd_name == \"fan_mode_set\") {\n    if (msg.payload == \"0\") {\n        msg.ac_info.cmds.push({\n            cmd: mqtt_topic_cmd_name_to_cmd[\"power_set\"],\n            val: 0x00\n        });\n    } else {\n        msg.ac_info.cmds.push({\n            cmd: mqtt_topic_cmd_name_to_cmd[mqtt_topic_cmd_name],\n            val: mqtt_payload_fan_mode_name_to_cmd_val[msg.payload]\n        });\n        msg.ac_info.cmds.push({\n            cmd: mqtt_topic_cmd_name_to_cmd[\"power_set\"],\n            val: 0x01\n        });\n    }\n}\n\nif (mqtt_topic_cmd_name == \"state_query\") {\n    msg.ac_info.cmds.push({\n        cmd: mqtt_topic_cmd_name_to_cmd[mqtt_topic_cmd_name],\n        val: msg.payload\n    });\n}\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":200,"y":1160,"wires":[["16720f56ed9e68e1"]]},{"id":"16720f56ed9e68e1","type":"function","z":"f70bf744855de309","g":"609d620537312d9b","name":"生成控制指令","func":"msg.ac_info.raw_cmds = [];\nmsg.ac_info.cmds.forEach(e => {\n    msg.ac_info.raw_cmds.push(Buffer.from([\n        0x32, e.cmd == 0x01 ? 0x03 : 0x06,\n        msg.ac_info.addr[0], msg.ac_info.addr[1] + e.cmd,\n        0x00,\n        e.val\n    ]));\n});\n\nmsg.payload = msg.ac_info.raw_cmds;\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":220,"y":1220,"wires":[["434516469018af7a"]]},{"id":"434516469018af7a","type":"split","z":"f70bf744855de309","g":"609d620537312d9b","name":"拆分多条指令","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","property":"payload","x":220,"y":1280,"wires":[["1f0874717c018c27"]]},{"id":"1f0874717c018c27","type":"function","z":"f70bf744855de309","g":"609d620537312d9b","name":"crc16","func":"// CRC-16 Modbus计算函数\nfunction crc16(buffer) {\n    let crc = 0xFFFF;\n    for (let i = 0; i < buffer.length; i++) {\n        crc ^= buffer[i]; // XOR byte into least sig. byte of crc\n        for (let j = 0; j < 8; j++) { // Loop over each bit\n            if ((crc & 0x0001) !== 0) {\n                crc >>= 1; // Shift right and XOR 0xA001 if the LSB is 1\n                crc ^= 0xA001;\n            } else {\n                crc >>= 1; // Just shift right\n            }\n        }\n    }\n    // CRC-16输出为2字节，低字节在前，高字节在后\n    return Buffer.from([crc & 0xFF, (crc >> 8) & 0xFF]);\n}\n\n// 获取输入的msg.payload（假设为Buffer）\nlet data = msg.payload;\n\n// 计算CRC\nlet crc = crc16(data);\n\n// 将CRC附加到原始数据\nmsg.payload = Buffer.concat([data, crc]);\n\n// 返回msg\nreturn msg;\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":190,"y":1340,"wires":[["288b15122ef03e69"]]},{"id":"bc5d1bbf9b164e5b","type":"link in","z":"f70bf744855de309","g":"609d620537312d9b","name":"link in 5","links":["1bcc5df7fcbc91e0"],"x":95,"y":1040,"wires":[["a7803743c8e0283c"]]},{"id":"288b15122ef03e69","type":"link out","z":"f70bf744855de309","g":"609d620537312d9b","name":"link out 8","mode":"link","links":["2b089d04f37508c6"],"x":315,"y":1340,"wires":[]},{"id":"a7803743c8e0283c","type":"function","z":"f70bf744855de309","g":"609d620537312d9b","name":"设置设备类型","func":"msg.ac_info = msg.ac_info || {};\n\nlet mqtt_topic_ac_type = msg.topic.split('/')[1];\nmsg.ac_info.type = mqtt_topic_ac_type;\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":220,"y":1040,"wires":[["5e3679fccf5238c0"]]},{"id":"25f6df45e5d0d842","type":"debug","z":"f70bf744855de309","g":"18cbecd2d2bc9db6","name":"debug 2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":400,"y":840,"wires":[]},{"id":"3c5783772d0bda43","type":"mqtt-broker","name":"","broker":"192.168.188.18","port":"1883","clientid":"","autoConnect":true,"usetls":false,"protocolVersion":"4","keepalive":"60","cleansession":true,"autoUnsubscribe":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","birthMsg":{},"closeTopic":"","closeQos":"0","closeRetain":"false","closePayload":"","closeMsg":{},"willTopic":"","willQos":"0","willRetain":"false","willPayload":"","willMsg":{},"userProps":"","sessionExpiry":""}]
#+end_src
